



# FinMemAdvancedReflection: 자기반성하는 AI 주식 트레이딩 에이전트

본 프로젝트는 대규모 언어 모델(LLM)을 활용하여 실제 금융 전문가처럼 사고하고, 자신의 투자 실수를 통해 학습하는 지능형 주식 트레이딩 에이전트를 구축합니다.

이 프로젝트는 기존 FinMem의 아이디어를 바탕으로, 다음과 같은 핵심적인 개선점을 도입하여 완전히 새로운 차원의 의사결정 시스템을 구현했습니다.

---

## 🚀 핵심 개선점 (Key Features)

기존 FinMem 모델이 감성 분석에 의존했다면, 저희는 LLM의 추론 능력을 극대화하는 새로운 아키텍처를 설계했습니다.

### 1. 분석의 구조화: 정량(Quantitative) & 정성(Qualitative) 분석 분리 

LLM이 비정형 텍스트에서 특정 숫자(P/E, CAGR 등)를 정확히 계산하거나 추출하는 데 어려움을 겪는다는 점을 파악했습니다. 이 문제를 해결하기 위해, 분석 단계를 다음과 같이 명확히 분리했습니다. 

- **정량(Quantitative) 분석**: 신뢰할 수 있는 금융 데이터 API를 통해 P/E, 부채비율 등 구조화된 숫자 데이터를 직접 가져옵니다. 이를 통해 '가치 투자자' 페르소나가 정확한 데이터를 기반으로 밸류에이션 리스크를 판단할 수 있게 됩니다.
-  **정성(Qualitative) 분석**: LLM이 가장 잘하는 영역으로, 뉴스, 공시 등 비정형 텍스트의 맥락과 감성을 분석하여 '경쟁 해자', '단기 호재/악재'와 같은 서사적 정보를 추출하는 데 집중합니다.

이러한 **역할 분담**은 LLM의 환각(Hallucination)을 최소화하고, 각 페르소나가 자신의 전문성에 맞는 정확한 정보를 바탕으로 의견을 제시하도록 하여 전체 분석의 신뢰도를 극대화합니다.

### 2. 멀티-페르소나 투자 위원회 (Multi-Persona Investment Committee)

단일 관점의 분석을 탈피하여, 각기 다른 투자 철학을 가진 3개의 AI 페르소나가 독립적인 분석을 수행합니다.

-   **가치 투자자 (Value Investor)**: 재무 건전성, 밸류에이션, 장기적 리스크를 분석합니다.
-   **성장 투자자 (Growth Investor)**: 기술 혁신, 시장 확장성(TAM), 성장 촉매제를 분석합니다.
-   **기술적 분석가 (Technical Trader)**: 시장 심리, 차트 패턴, 모멘텀을 분석합니다.

최종적으로 **CIO(최고 투자 책임자)** 페르소나가 이들의 상충되는 의견을 종합하여, 가장 합리적인 투자 결정을 내립니다.

### 3. 자기반성 학습 루프 (Self-Correction Loop)
에이전트는 단순히 거래만 하는 것이 아니라, 자신의 과거를 복기하며 학습합니다. 이 기능은 원본 FinMem의 `reflection` 모듈을 대폭 개선하여 구현되었습니다.

-   **오답 노트 (Failure Memory)**: 거래에서 손실이 발생하면, "왜 실패했는가?"를 스스로 분석하여 그 원인을 '실패 기억'에 기록합니다.
-   **동적 페르소나 전환**: 다음 분석 시, "오답 노트"와 현재 시장 상황(상승장/하락장)을 최우선으로 고려하여, 자신의 기본 성격(System Prompt)을 동적으로 변경합니다. 예를 들어, 하락장에서는 극도로 보수적인 리스크 관리자로 변신하여 섣부른 매수를 자제합니다.



---

## ⚙️ 모델 아키텍처 및 의사결정 흐름

에이전트의 의사결정은 리트리버 검색(정보 수집) -> 생성(분석 및 결정)의 큰 흐름을 따르며, 이는 4단계의 연쇄적인 생성(Generation) 과정으로 이루어집니다.

#### **1단계: 정보 수집 (리트리버 검색)**
- 분석의 가장 첫 단계에서 **단 한 번** 일어납니다.

- 각 페르소나의 "관심사"에 맞는 쿼리 키워드를 사용하여, `memorydb`의 모든 기억(단기/중기/장기)에서 관련 문서를 최대 `top_k`(7개)씩 가져옵니다

- 각 문서는 **관련성(Relevance)**,  **중요도(Importance)**, 그리고 **최신성(Recency)**을 종합하여 최종 점수가 매겨집니다.  이는 원본 FinMem의 연구를 따릅니다: 
  $$
  Score = Relevance + Importance + Recency
  $$

- 이 단계가 끝나면, 중복이 제거되고 무작위로 섞인 **하나의 통합된 회의 자료**가 만들어집니다. 이후의 모든 분석은 오직 이 자료만을 기반으로 진행됩니다.

  | 페르소나      | 벡터 DB 검색에 사용하는 쿼리                                 |
  | ------------- | ------------------------------------------------------------ |
  | 가치 투자자   | financial health, debt, cash flow, intrinsic value, margin of safety |
  | 성장 투자자   | new products, market share, innovation, user growth, future catalyst |
  | 기술적 분석가 | stock chart, moving average, trading volume, market sentiment, short-term news |

#### **2단계: 기초 분석 (정량/정성 분석 생성)**
-   1단계에서 만든 회의 자료 전체를 LLM에게 전달하며, 두 가지 종류의 요약 보고서를 **생성**하도록 지시합니다.
    1.  **정성(Qualitative) 분석**: 뉴스, 공시 등 텍스트를 읽고 '경쟁 해자', '단기 호재/악재'와 같은 서사적 정보를 요약합니다.
    2.  **정량(Quantitative) 분석**: 외부 금융 데이터 API를 통해 P/E, 부채비율 등 정확한 숫자 데이터를 가져와 `quant_analysis` 보고서를 구성합니다.

#### **3단계: 페르소나별 심층 분석**
-   2단계에서 생성된 `quant_analysis`와 `qual_analysis` 보고서가 이제 입력값으로 사용됩니다. 각 페르소나(가치/성장/기술)는 이 두 개의 요약 보고서를 전달받아, 자신의 투자 철학에 맞춰 2차 분석 보고서를 생성합니다.

#### **4단계: 최종 결정**
- 최종적으로 **CIO 페르소나**는 지금까지 생성된 **모든 결과물**(`quant_analysis`, `qual_analysis`, 그리고 3명의 페르소나 분석 보고서)을 전부 전달받습니다. 이 모든 정보를 종합하여 최종 투자 계획을 **생성**하며, 여기에는 `investment_decision` ('매수/매도/보유')과 그 근거가 된 핵심 문서 ID 3개가 포함됩니다.

  

## 📊 투자 결과 요약 (Performance Summary)

4개의 주요 기술주(AAPL, MSFT, NVDA, TSLA)에 대한 시뮬레이션을 진행했습니다. 각 차트는 해당 기간 동안의 주가 변동 위에 에이전트의 실제 매수(▲) 및 매도(▼) 시점을 표시합니다.

|       Apple (AAPL)        |     Microsoft (MSFT)      |
| :-----------------------: | :-----------------------: |
| ![](result/aapl/aapl.png) | ![](result/msft/msft.png) |
|       NVIDIA (NVDA)       |       Tesla (TSLA)        |
| ![](result/nvda/nvda.png) | ![](result/tsla/tsla.png) |



- **핵심 전략:** **스윙 트레이딩(Swing Trading)**. 시장의 단기적인 추세(파동)를 이용하여 2~3일에서 수 주간의 포지션을 가져가며 수익을 창출합니다.
- **강점 (Strengths):**
  - **📈 추세 활용 능력:** 명확한 추세가 나타날 때, 흐름에 편승하여 수익을 극대화합니다.
  - **🛡️ 위험 관리 및 자산 방어:** 하락장이나 횡보장에서도 변동성을 이용해 손실을 최소화하고 자산을 방어하는 능력이 탁월합니다.
  - **🤖 감정 배제:** FOMO(추격 매수)나 공포(패닉 매도)에 휘둘리지 않고, 정해진 알고리즘에 따라 기계적으로 거래합니다.
- **약점 (Weaknesses):**
  - **횡보장 함정 (Whipsaw):** 방향성 없이 작은 폭으로만 움직이는 지루한 횡보장에서는 잦은 매매로 인해 작은 손실이 누적될 수 있습니다.
  - **기회비용 발생:** 위험 관리를 우선시하기 때문에, MSFT 사례처럼 강력한 랠리의 일부 구간을 놓치는 기회비용이 발생할 수 있습니다.



결과적으로  **큰 수익**을 노리기보다는 **잃지 않는 투자**에 더 중점을 둔, 위험 회피적인 성향을 가진 전략을 사용한다고 해석할수 있습니다. 더 위험을 감수하는 전략을 취하고 싶다면, `config/` 폴더 안의 `.toml` 파일을 열어 분석할 종목의 `system_message`를 수정해주세요.



---

## 🛠️ 시작하기 (Getting Started)

프로젝트를 실행하고 결과를 확인하는 과정은 크게 3단계로 이루어집니다.

### 1단계: 환경 설정

1.  **가상 환경 생성 및 활성화**:
    프로젝트에 필요한 모든 라이브러리는 `myenv.yml` 파일에 정의되어 있습니다. 아래 명령어를 사용하여 `finmem310`이라는 이름의 Conda 가상 환경을 생성하고 활성화합니다.

    ```bash
    # 1. myenv.yml 파일로 가상 환경 생성
    conda env create -f myenv.yml
    
    # 2. 생성된 가상 환경 활성화
    conda activate finmem310
    ```

2.  **API 키 설정**:
    프로젝트 루트 디렉토리에 `.env` 파일을 생성하고, 그 안에 자신의 OpenAI API 키를 다음과 같이 입력합니다. `load_dotenv(override=True)` 옵션을 통해 이 키가 최우선으로 사용됩니다.

    ```
    OPENAI_API_KEY="sk-..."
    ```

### 2단계: 시뮬레이션 실행

모든 시뮬레이션은 `run_openai.sh` 셸 스크립트를 통해 실행됩니다.

1.  **Config 파일 수정**:
    -   `config/` 폴더 안의 `.toml` 파일을 열어 분석할 종목의 `system_message`, `trading_symbol` 등을 수정합니다.

2.  **스크립트 실행**:
    -   터미널에서 아래 명령어를 실행합니다.

    ```bash
    # 기본 설정으로 실행 (스크립트 내부에 정의된 값 사용)
    ./run_openai.sh
    
    # 기간과 결과 저장 경로를 직접 지정하여 실행
    # 형식: ./run_openai.sh [시작일] [종료일] [결과 저장 경로]
    ./run_openai.sh 2022-01-01 2023-12-31 data/05_model_output/my_nvda_run
    ```
    > **체크포인트**: 시뮬레이션이 중간에 중단되더라도, 동일한 명령어를 다시 실행하면 지정된 `[결과 저장 경로]`에 저장된 체크포인트를 통해 자동으로 이어서 실행됩니다.

### 3단계: 결과 확인 및 분석

1.  **리포트 생성**:
    -   시뮬레이션이 완료되면, `save_file.py`를 사용하여 포트폴리오 내역, 성과 지표, 전체 분석 리포트 등 3개의 결과 파일을 생성합니다.

    ```bash
    python save_file.py --output-path data/05_model_output/my_nvda_run
    ```

2.  **상세 분석 (Jupyter Notebook)**:
    -   **`note_book.ipynb`** 파일을 열어, 방금 생성된 결과 파일들을 시각화하고 심층적으로 분석할 수 있습니다.
    -   이 노트북을 통해 에이전트의 일별 자산 변화, 거래 내역, 그리고 각 시점의 의사결정 과정을 상세히 추적하고 평가할 수 있습니다.

---

## 📜 라이선스 (License)

본 프로젝트는 원본 FinMem 프로젝트의 MIT 라이선스를 따르며, 추가적인 기여자의 저작권을 포함하고 있습니다. 자세한 내용은 `LICENSE` 파일을 참고해 주십시오.